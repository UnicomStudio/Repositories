# Maintainer: easterNday <849919718@qq.com>

pkgname=read-cat-git
_pkgname=read-cat
pkgver=1.0.0
_pkgsubver=dev.240707
pkgrel=1
_nodeversion=20.15.0
epoch=
pkgdesc="一款免费、开源、简洁、纯净、无广告的小说阅读器"
arch=('any')
url="https://github.com/read-cat/read-cat"
license=('GPL')
groups=()
depends=()
makedepends=('npm' 'nvm')
checkdepends=()
optdepends=()
provides=()
conflicts=()
replaces=()
backup=()
options=()
install=
changelog=

source=(
    git+${url}.git#branch=dev
    "ReadCat.desktop"
)
noextract=()
sha256sums=(SKIP SKIP)
b2sums=(SKIP SKIP)
validpgpkeys=()

shopt -s extglob

_ensure_local_nvm() {
  # lets be sure we are starting clean
  which nvm >/dev/null 2>&1 && nvm deactivate && nvm unload

  export NVM_DIR="${srcdir}/${_pkgname}/.nvm"
  # The init script returns 3 if version
  #   specified in ./.nvrc is not (yet) installed in $NVM_DIR
  #   but nvm itself still gets loaded ok
  source /usr/share/nvm/init-nvm.sh || [[ $? != 1 ]]
}

prepare() {
  _ensure_local_nvm
  cd ${_pkgname}
  nvm install ${_nodeversion}
}

build() {
    _ensure_local_nvm
    cd ${_pkgname}
    npm install

    export GIT_TAG="${pkgver}-${_pkgsubver}"
    export NODE_OPTIONS="--max-old-space-size=4096"

    npm run make --tag="refs/tags/v${GIT_TAG}"
    npm run build:linux --noEmitOnError
}

package() {
    echo "Hello"
    cd ${_pkgname}

    # install -dm755 "${pkgdir}/opt/insomnia"

    # cp -r packages/insomnia/dist/linux-*unpacked/. "${pkgdir}/opt/insomnia"

    # install -Dm644 "${srcdir}/${pkgname}.desktop" -t "${pkgdir}/usr/share/applications"
    # install -Dm644 packages/insomnia/src/ui/images/insomnia-logo.svg "${pkgdir}/usr/share/pixmaps/insomnia.svg"
    # install -Dm644 LICENSE -t "${pkgdir}/usr/share/licenses/${pkgname}"
}
